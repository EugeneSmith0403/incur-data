services:
  # Infrastructure Services
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: dln-rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: password
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: dln-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  clickhouse:
    image: clickhouse/clickhouse-server:23.11-alpine
    container_name: dln-clickhouse
    ports:
      - "8123:8123"
      - "9000:9000"
    environment:
      CLICKHOUSE_DB: dln
      CLICKHOUSE_USER: default
      CLICKHOUSE_PASSWORD: ""
    volumes:
      - clickhouse-data:/var/lib/clickhouse
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "localhost:8123/ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Application Services
  # Indexer for src program
  indexer-src:
    build:
      context: .
      dockerfile: apps/indexer/Dockerfile
    container_name: dln-indexer-src
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      NODE_ENV: production
      INDEXER_PORT: 8081
      SOLANA_RPC_URL: ${SOLANA_RPC_URL}
      SOLANA_WSS_URL: ${SOLANA_WSS_URL}
      DLN_PROGRAM_ID: src5qyZHqTqecJV4aY6Cb6zDZLMDzrDKKezs22MPHr4
      RABBITMQ_URL: amqp://admin:password@rabbitmq:5672
      RABBITMQ_QUEUE_NAME: dln_transactions
      RABBITMQ_EXCHANGE_NAME: dln_exchange
      RABBITMQ_RETRY_DELAY: 5000
      RABBITMQ_MAX_RETRIES: 3
      REDIS_URL: redis://redis:6379
    ports:
      - "8081:8081"
    restart: unless-stopped

  # Indexer for dst program
  indexer-dst:
    build:
      context: .
      dockerfile: apps/indexer/Dockerfile
    container_name: dln-indexer-dst
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      NODE_ENV: production
      INDEXER_PORT: 8082
      SOLANA_RPC_URL: ${SOLANA_RPC_URL}
      SOLANA_WSS_URL: ${SOLANA_WSS_URL}
      DLN_PROGRAM_ID: dst5MGcFPoBeREFAA5E3tU5ij8m5uVYwkzkSAbsLbNo
      RABBITMQ_URL: amqp://admin:password@rabbitmq:5672
      RABBITMQ_QUEUE_NAME: dln_transactions
      RABBITMQ_EXCHANGE_NAME: dln_exchange
      RABBITMQ_RETRY_DELAY: 5000
      RABBITMQ_MAX_RETRIES: 3
      REDIS_URL: redis://redis:6379
    ports:
      - "8082:8082"
    restart: unless-stopped

  # Worker (single worker consuming from all indexers)
  worker:
    build:
      context: .
      dockerfile: apps/worker/Dockerfile
    container_name: dln-worker
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
    environment:
      NODE_ENV: production
      WORKER_ID: worker

      # Solana
      SOLANA_RPC_URL: ${SOLANA_RPC_URL}
      SOLANA_COMMITMENT: confirmed

      # RabbitMQ
      RABBITMQ_URL: amqp://admin:password@rabbitmq:5672
      RABBITMQ_QUEUE_NAME: dln_transactions
      RABBITMQ_EXCHANGE_NAME: dln_exchange
      RABBITMQ_RETRY_DELAY: 5000
      RABBITMQ_MAX_RETRIES: 3
      RABBITMQ_PREFETCH_COUNT: 10

      # Redis
      REDIS_URL: redis://redis:6379

      # ClickHouse
      CLICKHOUSE_URL: http://clickhouse:8123
      CLICKHOUSE_DATABASE: dln

      # Jupiter API
      JUPITER_API_KEY: ${JUPITER_API_KEY}

      # Worker Config
      WORKER_CONCURRENCY: 10
      WORKER_BATCH_SIZE: 100
      WORKER_BATCH_FLUSH_INTERVAL: 5000
      WORKER_METRICS_PORT: 9091
    ports:
      - "9091:9091"
    restart: unless-stopped

  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    container_name: dln-api
    ports:
      - "3000:3000"
    depends_on:
      clickhouse:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      NODE_ENV: production
      API_PORT: 3000
      API_HOST: 0.0.0.0
      CLICKHOUSE_URL: http://clickhouse:8123
      CLICKHOUSE_DATABASE: dln
      REDIS_URL: redis://redis:6379
    restart: unless-stopped

  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
    container_name: dln-web
    ports:
      - "3001:3001"
    depends_on:
      - api
    environment:
      WEB_API_URL: http://api:3000
    restart: unless-stopped

volumes:
  rabbitmq-data:
  redis-data:
  clickhouse-data:

networks:
  default:
    name: dln-network
